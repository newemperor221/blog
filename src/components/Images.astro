---
/* 
本文件是针对 Astro 内容合集图像默认值问题的一个 hack 
在当前版本中，Astro 内容合集事实上无法正确指定 default 值
当为 string时 Image 组件无法接受，为 object 时无法通过 Zod 校验
如果后续版本修复了此问题，可以将本函数安全地替换为post.data.cover
同时部分平台无法正确识别 ts 中导入的 avif，所以使用 astro 文件导出
*/

import { sample } from "es-toolkit";
import type { Post } from "@/toolkit/posts/types";
import type { ImageMetadata } from "astro";

import cover1 from "@/assets/images/cover-1.avif";
import cover2 from "@/assets/images/cover-2.avif";
import cover3 from "@/assets/images/cover-3.avif";
import cover4 from "@/assets/images/cover-4.avif";
import cover5 from "@/assets/images/cover-5.avif";
import cover6 from "@/assets/images/cover-6.avif";

import avatarImg from "@/assets/avatar.avif";

export const covers = [cover1, cover2, cover3, cover4, cover5, cover6];

// 统一的封面预设表：用于 fixedCover（固定封面）等需要从配置字符串解析成 ImageMetadata 的场景
// 说明：Astro 的 <Image /> 更适合接收 ImageMetadata（静态导入结果），而不是任意字符串。
export const coverPresets: Record<string, ImageMetadata> = {
  "cover-1": cover1,
  "cover-2": cover2,
  "cover-3": cover3,
  "cover-4": cover4,
  "cover-5": cover5,
  "cover-6": cover6,
};

/**
 * 将 theme.config.ts 中的 fixedCover 字符串解析为可渲染的图片源。
 * - 如果是预设 key（如 "cover-1"），返回静态导入的 ImageMetadata（走 Astro 资源管线）。
 * - 否则原样返回字符串（例如 public 路径或远程 URL），由渲染侧使用 <img> 兜底。
 */
export function resolveFixedCover(
  fixedCover?: string,
): ImageMetadata | string | undefined {
  if (!fixedCover) return undefined;
  return coverPresets[fixedCover] ?? fixedCover;
}

export function getPostCover(post: Partial<Post>): ImageMetadata {
  if (post?.data?.cover) {
    return post.data.cover;
  }

  return sample(covers ?? []);
}

export const avatar = avatarImg;
---
